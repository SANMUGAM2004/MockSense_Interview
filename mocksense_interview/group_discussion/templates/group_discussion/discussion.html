<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Discussion</title>
    <script>
        let videoStream;
        let confusedStartTime = null;
        let quoteDisplayed = false;

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    videoStream = stream;
                    document.getElementById("videoElement").srcObject = stream;
                    setInterval(captureImage, 3000);  
                })
                .catch(error => console.error("Error accessing webcam:", error));
        }

        function captureImage() {
            let video = document.getElementById("videoElement");
            let canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let imageData = canvas.toDataURL("image/jpeg");
            sendImageForEmotionDetection(imageData);
        }

        function sendImageForEmotionDetection(imageData) {
            fetch("/group_discussion/detect_emotion/", {  // âœ… Ensure this matches your Django URL
                method: "POST",  // âœ… This must be POST
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "image": imageData })  // âœ… Ensure JSON data is sent
            })
            .then(response => response.json())
            .then(data => {
                console.log("Emotion Response:", data);  // âœ… Debug to see emotion output
                document.getElementById("emotionText").innerText = `Emotion: ${data.emotion}`;
                if (data.quote) {
                    showQuote(data.quote);
                }
            })
            .catch(error => console.error("Error detecting emotion:", error));
        }
        

        function showQuote(quote) {
            let quoteBox = document.getElementById("quoteBox");
            quoteBox.innerText = quote;
            quoteBox.style.display = "block";
            setTimeout(() => {
                quoteBox.style.display = "none";
                quoteDisplayed = false;
                confusedStartTime = null; 
            }, 7000);
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        }

        window.onload = startCamera;
        window.onbeforeunload = stopCamera;
    </script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }

        .right-container {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        video {
            width: 180px;
            height: auto;
            border: 2px solid black;
            border-radius: 10px;
        }

        .emotion-container {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            width: 220px;
        }

        .quote {
            font-style: italic;
            font-size: 16px;
            margin-top: 5px;
            color: yellow;
        }
    </style>
</head>
<body>
    {% include 'includes/navbar.html' %}
    <h2>Group Discussion</h2>

    <div class="right-container">
        <video id="videoElement" autoplay></video>
        <div class="emotion-container">
            <p id="emotionText">Emotion: Detecting...</p>
            <p class="quote" id="quoteBox"></p>
        </div>
    </div>

    <div class="container">
        <h2>Group Discussion</h2>
        <form id="gdForm" method="post">
            {% csrf_token %}
            <input type="text" id="topic" placeholder="Enter discussion topic..." required>
            <button type="button" onclick="startDiscussion()">Start Discussion</button>
        </form>
        <div class="messages" id="messages"></div>
        <button onclick="startSpeechRecognition()">ðŸŽ¤ Speak Your Response</button>
        <p id="recording-status"></p>
        <input type="text" id="userResponse" placeholder="Your response..." required>
        <button onclick="sendResponse()">Send</button>
    </div>

    <script>
        function getCSRFToken() {
            let csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return csrfToken ? csrfToken.value : "";
        }

        function startDiscussion() {
            const topic = document.getElementById("topic").value;
            document.getElementById("messages").innerHTML = `<p><b>Topic:</b> ${topic}</p>`;
        }

        function startSpeechRecognition() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.start();
            document.getElementById("recording-status").textContent = "Recording... ðŸŽ¤";
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById("userResponse").value = transcript;
                document.getElementById("recording-status").textContent = "";
            };
            recognition.onerror = function() {
                document.getElementById("recording-status").textContent = "Error in speech recognition.";
            };
        }

        function speak(text, voiceType) {
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            utterance.voice = voices.find(voice => voice.name.includes(voiceType)) || voices[0];
            utterance.rate = 1;
            speechSynthesis.speak(utterance);
        }

        function sendResponse() {
            const userResponse = document.getElementById("userResponse").value;
            if (!userResponse.trim()) return;
            const topic = document.getElementById("topic").value;
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML += `<p class="message user"><b>You:</b> ${userResponse}</p>`;
            document.getElementById("userResponse").value = "";
            fetch("/gd/", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ "topic": topic, "user_response": userResponse })
            })
            .then(response => response.json())
            .then(data => {
                messagesDiv.innerHTML += `<p class="message ai"><b>AI Male:</b> ${data.ai_male}</p>`;
                messagesDiv.innerHTML += `<p class="message ai"><b>AI Female:</b> ${data.ai_female}</p>`;
                speak(data.ai_male, "Male");
                speak(data.ai_female, "Female");
            })
            .catch(error => console.error("Error:", error));
        }
        
    </script>
</body>
</html>
